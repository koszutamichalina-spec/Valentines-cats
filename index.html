<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Duo üíó</title>
  <style>
    body{margin:0;font-family:system-ui;background:#050505;color:#ffd7ea}
    .wrap{max-width:980px;margin:0 auto;padding:14px;text-align:center}
    h1{margin:8px 0 6px}
    canvas{width:100%;height:auto;border:3px solid hotpink;border-radius:16px;background:#0a0a0a;touch-action:none}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px 0}
    button,textarea{border:2px solid hotpink;border-radius:14px;background:transparent;color:#ffd7ea;font-weight:800}
    button{padding:10px 14px;cursor:pointer}
    textarea{width:min(520px,92vw);height:110px;padding:10px}
    .small{font-size:12px;opacity:.75}
    .pill{border:2px solid hotpink;border-radius:999px;padding:8px 12px}
    .pads{display:flex;gap:10px;justify-content:space-between;margin-top:10px}
    .pad{width:48%;border:2px solid rgba(255,105,180,.7);border-radius:16px;padding:10px;touch-action:none}
    .base{width:120px;height:120px;border:2px solid rgba(255,105,180,.7);border-radius:999px;margin:8px auto 0;position:relative}
    .knob{width:54px;height:54px;border:2px solid rgba(255,105,180,.9);border-radius:999px;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.25)}

    /* overlay nagrody */
    #overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.92);
      display:none; align-items:center; justify-content:center; flex-direction:column;
      z-index:999; padding:18px;
    }
    #overlay .card{
      width:min(520px,92vw);
      border:2px solid rgba(255,105,180,.95);
      border-radius:18px;
      padding:16px;
      background:rgba(10,10,10,.7);
      box-shadow:0 0 30px rgba(255,105,180,.25);
    }
    #rewardImg{
      width:100%;
      border-radius:14px;
      border:2px solid rgba(255,105,180,.55);
      display:block;
      margin-top:10px;
    }
    #overlay h2{margin:0 0 8px}
    #overlay p{margin:6px 0 0; opacity:.9}
    #overlay button{margin-top:12px; width:100%}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Duo üíó</h1>
  <div class="row">
    <button id="hostBtn">HOST (ja tworzƒô)</button>
    <button id="joinBtn">JOIN (ja do≈ÇƒÖczam)</button>
    <div class="pill">Status: <span id="status">offline</span></div>
    <div class="pill">Poziom: <span id="lvl">1</span>/3</div>
  </div>

  <div id="signal" style="display:none">
    <p class="small">
      1) HOST klik ‚ÄúGenerate Offer‚Äù i skopiuj kod do JOIN. <br/>
      2) JOIN klik ‚ÄúCreate Answer‚Äù i skopiuj kod do HOST. <br/>
      3) HOST klik ‚ÄúFinalize‚Äù.
    </p>

    <div class="row">
      <button id="makeOffer">Generate Offer</button>
      <button id="makeAnswer">Create Answer</button>
      <button id="finalize">Finalize</button>
    </div>

    <div class="row">
      <textarea id="outBox" placeholder="Tu pojawi siƒô kod do skopiowania"></textarea>
    </div>
    <div class="row">
      <textarea id="inBox" placeholder="Wklej tu kod od drugiej osoby"></textarea>
    </div>
  </div>

  <canvas id="cv" width="900" height="520"></canvas>

  <div class="pads">
    <div class="pad">
      <div><b>Tw√≥j joystick</b></div>
      <div class="base" id="base"><div class="knob" id="knob"></div></div>
      <div class="small">PrzeciƒÖgnij k√≥≈Çko</div>
    </div>
    <div class="pad">
      <div><b>Jak przej≈õƒá poziom?</b></div>
      <div class="small" style="margin-top:10px">
        Podejd≈∫cie <b>oboje</b> do r√≥≈ºowego portalu po prawej üíó
      </div>
    </div>
  </div>
</div>

<!-- audio (musi byƒá w repo jako win.mp3) -->
<audio id="winAudio" src="win.mp3" preload="auto"></audio>

<!-- overlay nagrody -->
<div id="overlay">
  <div class="card">
    <h2>WYGRANA üíó</h2>
    <p>Odbierz nagrodƒô. Kliknij przycisk, ≈ºeby odpaliƒá muzykƒô üé∂</p>
    <!-- podmie≈Ñ IMG_2704.jpeg na swojƒÖ nazwƒô pliku -->
    <img id="rewardImg" src="IMG_2704.jpeg" alt="Nagroda" onerror="this.style.display='none'">
    <button id="playWin">GRAJ MUZYKƒò + POKA≈ª NAGRODƒò</button>
    <button id="restartAll">ZACZNIJ OD NOWA</button>
  </div>
</div>

<script>
(() => {
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");
  const statusEl = document.getElementById("status");
  const lvlEl = document.getElementById("lvl");

  const hostBtn = document.getElementById("hostBtn");
  const joinBtn = document.getElementById("joinBtn");
  const signal = document.getElementById("signal");
  const makeOffer = document.getElementById("makeOffer");
  const makeAnswer = document.getElementById("makeAnswer");
  const finalize = document.getElementById("finalize");
  const outBox = document.getElementById("outBox");
  const inBox = document.getElementById("inBox");

  const overlay = document.getElementById("overlay");
  const playWin = document.getElementById("playWin");
  const restartAll = document.getElementById("restartAll");
  const winAudio = document.getElementById("winAudio");

  // joystick
  const base = document.getElementById("base");
  const knob = document.getElementById("knob");
  const stick = {active:false,id:null,cx:0,cy:0,dx:0,dy:0};

  function setKnob(dx,dy){
    const r=42, len=Math.hypot(dx,dy), k=len>r? r/len:1;
    const x=dx*k, y=dy*k;
    knob.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
    stick.dx = x/r; stick.dy = y/r;
  }
  function resetKnob(){
    stick.active=false; stick.id=null; stick.dx=0; stick.dy=0;
    knob.style.transform = "translate(-50%,-50%)";
  }
  base.addEventListener("pointerdown",(e)=>{
    base.setPointerCapture(e.pointerId);
    const rect=base.getBoundingClientRect();
    stick.active=true; stick.id=e.pointerId;
    stick.cx=rect.left+rect.width/2; stick.cy=rect.top+rect.height/2;
    setKnob(e.clientX-stick.cx, e.clientY-stick.cy);
  });
  base.addEventListener("pointermove",(e)=>{
    if(!stick.active||e.pointerId!==stick.id) return;
    setKnob(e.clientX-stick.cx, e.clientY-stick.cy);
  });
  base.addEventListener("pointerup",(e)=>{ if(e.pointerId===stick.id) resetKnob(); });
  base.addEventListener("pointercancel",(e)=>{ if(e.pointerId===stick.id) resetKnob(); });

  // --- WebRTC (manual signaling) ---
  let role = null; // "host" or "join"
  let pc = null;
  let dc = null;

  function setStatus(t){ statusEl.textContent = t; }
  function b64(obj){ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))); }
  function unb64(s){ return JSON.parse(decodeURIComponent(escape(atob(s.trim())))); }

  async function makePC(){
    pc = new RTCPeerConnection({
      iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    pc.oniceconnectionstatechange = () => {
      setStatus(pc.iceConnectionState);
    };

    pc.ondatachannel = (e) => {
      dc = e.channel;
      hookDC();
    };
  }

  function hookDC(){
    dc.onopen = () => setStatus("connected üíó");
    dc.onclose = () => setStatus("closed");
    dc.onmessage = (e) => onNetMsg(e.data);
  }

  // --- GAME ---
  const MAX_LEVEL = 3;
  let level = 1;
  let won = false;

  const me = { id: null, x: 140, y: 420, r: 14 };
  const other = { id: null, x: 760, y: 420, r: 14 };

  // Host authoritative state
  const state = {
    a:{x:140,y:420},
    b:{x:760,y:420}
  };

  // portal (finish)
  const portal = { x: cv.width - 70, y: cv.height/2, r: 26 };

  // level backgrounds (robi siƒô coraz bardziej r√≥≈ºowo)
  const levelTint = [
    "rgba(255,105,180,.08)",
    "rgba(255,105,180,.14)",
    "rgba(255,105,180,.20)"
  ];

  function resetPositions(){
    state.a.x = 140; state.a.y = 420;
    state.b.x = 220; state.b.y = 420;
    me.x = state.a.x; me.y = state.a.y;
    other.x = state.b.x; other.y = state.b.y;
  }

  // Simple message protocol
  function send(obj){
    if(dc && dc.readyState==="open"){
      dc.send(JSON.stringify(obj));
    }
  }

  function onNetMsg(raw){
    let msg;
    try{ msg = JSON.parse(raw); } catch { return; }

    if(msg.t==="joinHello" && role==="host"){
      send({t:"assign", you:"b"});
      me.id = "a"; other.id = "b";
    }

    if(msg.t==="assign" && role==="join"){
      me.id = msg.you; // "b"
      other.id = "a";
    }

    if(msg.t==="input" && role==="host"){
      applyInput(state.b, msg.dx, msg.dy);
    }

    if(msg.t==="state" && role==="join"){
      lvlEl.textContent = msg.level;
      level = msg.level;
      won = !!msg.won;

      other.x = msg.a.x; other.y = msg.a.y;
      me.x = msg.b.x; me.y = msg.b.y;

      if(won) showWin();
    }
  }

  function applyInput(obj, dx, dy){
    const spd = 3.2;
    const len = Math.hypot(dx,dy) || 1;
    obj.x += (dx/len)*spd;
    obj.y += (dy/len)*spd;

    // bounds
    obj.x = Math.max(24, Math.min(cv.width-24, obj.x));
    obj.y = Math.max(24, Math.min(cv.height-24, obj.y));
  }

  function checkPortalBoth(){
    const da = Math.hypot(state.a.x-portal.x, state.a.y-portal.y);
    const db = Math.hypot(state.b.x-portal.x, state.b.y-portal.y);
    return da < (portal.r + 18) && db < (portal.r + 18);
  }

  function nextLevelOrWin(){
    if(level < MAX_LEVEL){
      level++;
      lvlEl.textContent = level;
      resetPositions();
    } else {
      won = true;
      showWin();
    }
  }

  function showWin(){
    overlay.style.display = "flex";
  }

  playWin.onclick = async () => {
    try{
      await winAudio.play();
    }catch(e){
      // jak safari siƒô uprze, nic nie szkodzi ‚Äî nagroda i tak siƒô pokazuje
    }
  };

  restartAll.onclick = () => {
    won = false;
    level = 1;
    lvlEl.textContent = level;
    overlay.style.display = "none";
    try{ winAudio.pause(); winAudio.currentTime = 0; }catch(e){}
    resetPositions();
    if(role==="host"){
      send({t:"state", level, won:false, a:state.a, b:state.b});
    }
  };

  // host sim loop
  function hostTick(){
    if(role!=="host") return;

    applyInput(state.a, stick.dx, stick.dy);

    // if both at portal => advance
    if(!won && checkPortalBoth()){
      nextLevelOrWin();
    }

    // publish
    if(dc && dc.readyState==="open"){
      send({t:"state", level, won, a:state.a, b:state.b});
    }

    // local reflect
    lvlEl.textContent = level;
    me.x = state.a.x; me.y = state.a.y;
    other.x = state.b.x; other.y = state.b.y;

    requestAnimationFrame(hostTick);
  }

  // join input loop
  function joinTick(){
    if(role!=="join") return;
    if(dc && dc.readyState==="open"){
      send({t:"input", dx:stick.dx, dy:stick.dy});
    }
    requestAnimationFrame(joinTick);
  }

  // draw loop (both sides)
  function draw(){
    // background
    ctx.fillStyle = "#0a0a0a";
    ctx.fillRect(0,0,cv.width,cv.height);

    // level tint
    ctx.fillStyle = levelTint[Math.max(0, Math.min(2, level-1))];
    ctx.fillRect(0,0,cv.width,cv.height);

    // frame
    ctx.strokeStyle = "rgba(255,105,180,.9)";
    ctx.lineWidth = 3;
    ctx.strokeRect(16,16,cv.width-32,cv.height-32);

    // portal
    ctx.strokeStyle = "rgba(255,105,180,1)";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.arc(portal.x, portal.y, portal.r, 0, Math.PI*2);
    ctx.stroke();

    ctx.fillStyle = "rgba(255,105,180,.25)";
    ctx.beginPath();
    ctx.arc(portal.x, portal.y, portal.r-6, 0, Math.PI*2);
    ctx.fill();

    // label
    ctx.fillStyle = "rgba(255,215,234,.92)";
    ctx.font = "700 18px system-ui";
    ctx.fillText(`POZIOM ${level}/3`, 28, 40);
    ctx.font = "600 14px system-ui";
    ctx.fillText("Wejd≈∫cie OBOJE do portalu üíó", 28, 62);

    // players
    function blob(x,y,fill){
      ctx.fillStyle = fill;
      ctx.beginPath(); ctx.arc(x,y,14,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle = "rgba(255,105,180,.9)";
      ctx.lineWidth = 2.5;
      ctx.stroke();
    }
    blob(me.x, me.y, "rgba(255,240,248,.92)");
    blob(other.x, other.y, "rgba(255,210,232,.65)");

    // together heart
    if(Math.hypot(me.x-other.x, me.y-other.y) < 50){
      const x=(me.x+other.x)/2, y=(me.y+other.y)/2 - 26, s=12;
      ctx.strokeStyle="rgba(255,105,180,.95)";
      ctx.lineWidth=3;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.bezierCurveTo(x - s, y - s, x - 2*s, y + s/2, x, y + 2*s);
      ctx.bezierCurveTo(x + 2*s, y + s/2, x + s, y - s, x, y);
      ctx.closePath();
      ctx.stroke();
    }

    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);

  // UI
  hostBtn.onclick = async () => {
    role="host";
    signal.style.display = "block";
    setStatus("host: ready");
    await makePC();
    dc = pc.createDataChannel("duo");
    hookDC();
    resetPositions();
  };

  joinBtn.onclick = async () => {
    role="join";
    signal.style.display = "block";
    setStatus("join: ready");
    await makePC();
  };

  makeOffer.onclick = async () => {
    if(role!=="host") return alert("Offer robi HOST");
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await new Promise(r=>setTimeout(r,1200));
    outBox.value = b64(pc.localDescription);
  };

  makeAnswer.onclick = async () => {
    if(role!=="join") return alert("Answer robi JOIN");
    const offerDesc = unb64(inBox.value);
    await pc.setRemoteDescription(offerDesc);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await new Promise(r=>setTimeout(r,1200));
    outBox.value = b64(pc.localDescription);

    pc.ondatachannel = (e) => {
      dc = e.channel;
      hookDC();
      dc.onopen = () => {
        setStatus("connected üíó");
        send({t:"joinHello"});
        joinTick();
      };
    };
  };

  finalize.onclick = async () => {
    if(role!=="host") return alert("Finalize robi HOST");
    const answerDesc = unb64(inBox.value);
    await pc.setRemoteDescription(answerDesc);

    dc.onopen = () => {
      setStatus("connected üíó");
      me.id="a"; other.id="b";
      resetPositions();
      level = 1;
      won = false;
      lvlEl.textContent = level;
      hostTick();
    };
  };
})();
</script>
</body>
</html>
